---
- name: Crear usuarios en Microsoft 365 (AWX-friendly)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    tenant_id: "{{ lookup('env','TENANT_ID') | default(vault_tenant_id | default('your-tenant-id'), true) }}"
    client_id: "{{ lookup('env','CLIENT_ID') | default(vault_client_id | default('your-client-id'), true) }}"
    client_secret: "{{ lookup('env','CLIENT_SECRET') | default(vault_client_secret | default('your-client-secret'), true) }}"

    # Dominio del UPN (defínelo en la Plantilla o Inventory). Ejemplo: contoso.com
    m365_domain: "{{ m365_domain | default('contoso.com') }}"

    # El Survey pedirá 'upn_local' (solo la parte a la izquierda de @)
    # Normalizamos: a minúsculas, espacios -> '.', y quitamos caracteres no permitidos
    upn_local_normalized: "{{ user_upn | lower | regex_replace('\\s+', '.') | regex_replace('[^a-z0-9._-]', '') }}"

    # Estas variables las rellenará el Survey:
    display_name: "{{ display_name }}"
    user_principal_name: "{{ upn_local_normalized }}@{{ m365_domain }}"
    mail_nickname: "{{ mail_nickname | default(upn_local_normalized) }}"
    password: "{{ temp_password }}"
    force_change_password: "{{ force_password | default(true) | bool }}"
    department: "{{ department | default('') }}"
    job_title: "{{ job_title | default('') }}"

  tasks:
    - name: Validar obligatorios
      assert:
        that:
          - display_name | length > 0
          - upn_local_normalized | length > 0
          - mail_nickname | length > 0
          - password | length >= 8
        fail_msg: "Faltan campos requeridos o no cumplen requisitos."

    - name: Crear usuario mediante Microsoft Graph API
      include_role:
        name: microsoft_graph_user
      vars:
        action: create
        user_data:
          display_name: "{{ display_name }}"
          user_principal_name: "{{ user_principal_name }}"
          mail_nickname: "{{ mail_nickname }}"
          password: "{{ password }}"
          force_change_password: "{{ force_change_password }}"
          department: "{{ department }}"
          job_title: "{{ job_title }}"
      tags: [create_users, users]
