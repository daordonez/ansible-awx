---
# Playbook interactivo para consultar y listar usuarios en Microsoft 365
# Este playbook solicita los filtros de b칰squeda interactivamente
name: Consultar usuarios en Microsoft 365
hosts: localhost
connection: local
gather_facts: false

vars:
  tenant_id: "{{ vault_tenant_id | default('your-tenant-id') }}"
  client_id: "{{ vault_client_id | default('your-client-id') }}"
  client_secret: "{{ vault_client_secret | default('your-client-secret') }}"

tasks:
  - name: Seleccionar tipo de consulta
    pause:
      prompt: |
        
        === CONSULTAR USUARIOS EN MICROSOFT 365 ===
        
        Seleccione el tipo de consulta que desea realizar:
        
        1. Buscar por nombre o email
        2. Filtrar por departamento
        3. Filtrar por estado (habilitado/deshabilitado)
        4. Listar todos los usuarios
        5. B칰squeda combinada (m칰ltiples filtros)
        
        Ingrese el n칰mero de opci칩n (1-5)
    register: query_type_input

  - name: Validar opci칩n seleccionada
    fail:
      msg: "Opci칩n no v치lida. Debe ingresar un n칰mero del 1 al 5."
    when: query_type_input.user_input | trim not in ['1', '2', '3', '4', '5']

  - name: Solicitar t칠rmino de b칰squeda (opci칩n 1)
    pause:
      prompt: |
        Ingrese el nombre o email del usuario a buscar
    register: search_term_input
    when: query_type_input.user_input | trim == '1'

  - name: Solicitar departamento (opci칩n 2)
    pause:
      prompt: |
        Ingrese el departamento a filtrar (ej. IT, RRHH, Ventas)
    register: department_input
    when: query_type_input.user_input | trim == '2'

  - name: Solicitar estado de usuario (opci칩n 3)
    pause:
      prompt: |
        Filtrar por estado:
        - 'true' para usuarios habilitados
        - 'false' para usuarios deshabilitados
        
        Ingrese true o false
    register: enabled_input
    when: query_type_input.user_input | trim == '3'

  - name: Configurar b칰squeda combinada - t칠rmino de b칰squeda
    pause:
      prompt: |
        === B칔SQUEDA COMBINADA ===
        
        T칠rmino de b칰squeda (nombre/email) - OPCIONAL, presione Enter para omitir
    register: combined_search_input
    when: query_type_input.user_input | trim == '5'

  - name: Configurar b칰squeda combinada - departamento
    pause:
      prompt: |
        Departamento - OPCIONAL, presione Enter para omitir
    register: combined_department_input
    when: query_type_input.user_input | trim == '5'

  - name: Configurar b칰squeda combinada - estado
    pause:
      prompt: |
        Estado (true/false) - OPCIONAL, presione Enter para omitir
    register: combined_enabled_input
    when: query_type_input.user_input | trim == '5'

  - name: Construir filtros de consulta - opci칩n 1
    set_fact:
      query_filters:
        search_term: "{{ search_term_input.user_input | trim }}"
    when: query_type_input.user_input | trim == '1'

  - name: Construir filtros de consulta - opci칩n 2
    set_fact:
      query_filters:
        department: "{{ department_input.user_input | trim }}"
    when: query_type_input.user_input | trim == '2'

  - name: Construir filtros de consulta - opci칩n 3
    set_fact:
      query_filters:
        enabled: "{{ enabled_input.user_input | trim }}"
    when: query_type_input.user_input | trim == '3'

  - name: Construir filtros de consulta - opci칩n 4
    set_fact:
      query_filters: {}
    when: query_type_input.user_input | trim == '4'

  - name: Construir filtros de consulta - opci칩n 5
    set_fact:
      query_filters: {}
    when: query_type_input.user_input | trim == '5'

  - name: A침adir t칠rmino de b칰squeda combinada
    set_fact:
      query_filters: "{{ query_filters | combine({'search_term': combined_search_input.user_input | trim}) }}"
    when: 
      - query_type_input.user_input | trim == '5'
      - combined_search_input.user_input | trim != ""

  - name: A침adir departamento combinado
    set_fact:
      query_filters: "{{ query_filters | combine({'department': combined_department_input.user_input | trim}) }}"
    when: 
      - query_type_input.user_input | trim == '5'
      - combined_department_input.user_input | trim != ""

  - name: A침adir estado combinado
    set_fact:
      query_filters: "{{ query_filters | combine({'enabled': combined_enabled_input.user_input | trim}) }}"
    when: 
      - query_type_input.user_input | trim == '5'
      - combined_enabled_input.user_input | trim != ""

  - name: Solicitar generar reporte
    pause:
      prompt: |
        쮻esea generar un reporte en archivo adem치s de mostrar los resultados? (s/N)
    register: generate_report_input

  - name: Mostrar filtros aplicados
    debug:
      msg: |
        
        === FILTROS DE B칔SQUEDA ===
        {% if query_filters | length > 0 %}
        {% for key, value in query_filters.items() %}
        - {{ key }}: {{ value }}
        {% endfor %}
        {% else %}
        Sin filtros - Se mostrar치n todos los usuarios
        {% endif %}

  - name: Consultar usuarios mediante Microsoft Graph API
    include_role:
      name: microsoft_graph_user
    vars:
      action: query
      filters: "{{ query_filters }}"
    tags:
      - query_users
      - users

  - name: Mostrar usuarios encontrados
    debug:
      msg: |
        
        === RESULTADOS DE LA B칔SQUEDA ===
        
        Total de usuarios encontrados: {{ queried_users | length if queried_users is defined else 0 }}
        
        {% if queried_users is defined and queried_users | length > 0 %}
        {% for user in queried_users[:10] %}
        {{ loop.index }}. {{ user.displayName }} ({{ user.userPrincipalName }})
           Departamento: {{ user.department | default('No especificado') }}
           Puesto: {{ user.jobTitle | default('No especificado') }}
           Estado: {{ 'Habilitado' if user.accountEnabled else 'Deshabilitado' }}
        
        {% endfor %}
        {% if queried_users | length > 10 %}
        ... y {{ queried_users | length - 10 }} usuarios m치s
        {% endif %}
        {% endif %}
    when: queried_users is defined
    tags:
      - show_results

  - name: Generar reporte de usuarios
    template:
      src: user_report.j2
      dest: "/tmp/user_report_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.txt"
    when: 
      - (generate_report_input.user_input | trim | lower) in ['s', 'si', 'yes', 'y']
      - queried_users is defined
    register: report_generated
    tags:
      - report

  - name: Mostrar ubicaci칩n del reporte
    debug:
      msg: |
        
        游늯 REPORTE GENERADO
        
        Archivo: {{ report_generated.dest }}
        Usuarios incluidos: {{ queried_users | length }}
    when: report_generated is succeeded
