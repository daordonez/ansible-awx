---
# Playbook para consultar usuarios en Microsoft 365 (AWX-friendly)
- name: Consultar usuarios en Microsoft 365
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    tenant_id: "{{ lookup('env','TENANT_ID') | default(vault_tenant_id | default('your-tenant-id'), true) }}"
    client_id: "{{ lookup('env','CLIENT_ID') | default(vault_client_id | default('your-client-id'), true) }}"
    client_secret: "{{ lookup('env','CLIENT_SECRET') | default(vault_client_secret | default('your-client-secret'), true) }}"

    # Variables opcionales del Survey para filtros:
    search_term: "{{ search_term | default('') }}"
    filter_department: "{{ filter_department | default('') }}"
    filter_enabled: "{{ filter_enabled | default('') }}"
    generate_report: "{{ generate_report | default(false) | bool }}"
    
    # Para b칰squeda espec칤fica por UPN (si se especifica user_upn)
    search_upn_normalized: "{{ user_upn | lower if user_upn is defined else '' }}"
    search_user_principal_name: "{{ search_upn_normalized }}@{{ m365_domain | default('contoso.com') if search_upn_normalized != '' else '' }}"

  tasks:
    - name: Construir filtros de consulta para b칰squeda espec칤fica por UPN
      set_fact:
        query_filters:
          upn_exact: "{{ search_user_principal_name }}"
      when: search_upn_normalized != ""

    - name: Construir filtros de consulta generales
      set_fact:
        query_filters: {}
      when: search_upn_normalized == ""

    - name: A침adir t칠rmino de b칰squeda general
      set_fact:
        query_filters: "{{ query_filters | combine({'search_term': search_term}) }}"
      when: 
        - search_upn_normalized == ""
        - search_term != ""

    - name: A침adir filtro por departamento
      set_fact:
        query_filters: "{{ query_filters | combine({'department': filter_department}) }}"
      when: 
        - search_upn_normalized == ""
        - filter_department != ""

    - name: A침adir filtro por estado habilitado
      set_fact:
        query_filters: "{{ query_filters | combine({'enabled': filter_enabled}) }}"
      when: 
        - search_upn_normalized == ""
        - filter_enabled != ""

    - name: Consultar usuarios mediante Microsoft Graph API
      include_role:
        name: microsoft_graph_user
      vars:
        action: query
        filters: "{{ query_filters }}"
      tags: [query_users, users]

    - name: Mostrar resultados de consulta
      debug:
        msg: |
          === RESULTADOS DE LA CONSULTA ===
          Total de usuarios encontrados: {{ queried_users | length if queried_users is defined else 0 }}
          
          {% if queried_users is defined and queried_users | length > 0 %}
          Primeros {{ [queried_users | length, 10] | min }} usuarios:
          {% for user in queried_users[:10] %}
          {{ loop.index }}. {{ user.displayName }} ({{ user.userPrincipalName }})
             Departamento: {{ user.department | default('No especificado') }}
             Puesto: {{ user.jobTitle | default('No especificado') }}
             Estado: {{ 'Habilitado' if user.accountEnabled else 'Deshabilitado' }}
          {% endfor %}
          {% if queried_users | length > 10 %}
          ... y {{ queried_users | length - 10 }} usuarios m치s
          {% endif %}
          {% endif %}
      when: queried_users is defined

    - name: Generar reporte de usuarios
      template:
        src: user_report.j2
        dest: "/tmp/user_report_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.txt"
      when: 
        - generate_report
        - queried_users is defined
        - queried_users | length > 0
      register: report_generated

    - name: Mostrar ubicaci칩n del reporte
      debug:
        msg: |
          游늯 REPORTE GENERADO
          Archivo: {{ report_generated.dest }}
          Usuarios incluidos: {{ queried_users | length }}
      when: report_generated is succeeded